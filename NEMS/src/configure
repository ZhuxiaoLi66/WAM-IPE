#!/bin/ksh

CHOSEN_MODULE="$2"

if [[ ! -d "conf" ]] ; then
    echo "ERROR: This script must be run from the NEMS/src/conf directory." 1>&2
    exit 1
fi

if [[ -z "$CHOSEN_MODULE" ]] ; then 
    echo "WARNING: modulefile was not supplied as the second argument" 1>&2
    echo "If possible, specify a modulefile relative to ../../modulefiles" 1>&2
    echo "I will guess the correct modulefile for you." 1>&2
fi

# copy_diff_files
copy_diff_files(){
  if ( ! cmp "$1" "$2" > /dev/null 2>&1 ) ; then
    set -xue
    cp $1 $2
    set +xue
  else
    echo "confirmed $2"
  fi
}

copy_diff_mod()  {
    if ( ! cmp "$1" "$2" > /dev/null 2>&1 ) ; then
	set -xue
	cp -fp "$1" "$2"
	set +xue
    else
	echo "confirmed $2"
    fi
    cat > "$2.sh" <<EOF
source $( pwd -P )/conf/module-setup.sh.inc
module use $( pwd -P )/conf
module load modules.nems
EOF
    cat > "$2.csh" <<EOF
source $( pwd -P )/conf/module-setup.csh.inc
module use $( pwd -P )/conf
module load modules.nems
EOF
}

#
# Standard
#

if [[ $1 = nmmb_intel_theia ]]; then
     set -x
     copy_diff_files ../../conf/configure.nems.Theia.intel_nmmb conf/configure.nems
     touch conf/externals.nems
     CHOSEN_MODULE="${CHOSEN_MODULE:-theia/ESMF_700_nmmb}"
     copy_diff_mod "../../modulefiles/$CHOSEN_MODULE" conf/modules.nems
     copy_diff_files ESMFVersionDefine_ESMF_NUOPC.h ESMFVersionDefine.h
     set +x
     echo "NEMS/NMMB build on Theia using Intel and ESMF v7.0.0"
elif [[ $1 = nmmb_intel_wcoss ]]; then
     set -x
     copy_diff_files ../../conf/configure.nems.Wcoss.intel_nmmb conf/configure.nems
     touch conf/externals.nems
     CHOSEN_MODULE="${CHOSEN_MODULE:-wcoss.phase1/ESMF_700_nmmb}"
     copy_diff_mod "../../modulefiles/$CHOSEN_MODULE" conf/modules.nems
     copy_diff_files ESMFVersionDefine_ESMF_NUOPC.h              ESMFVersionDefine.h
     set +x
     echo "NEMS/NMMB build on Wcoss using Intel and ESMF v7.0.0"
elif [[ $1 = gsm_intel_theia ]]; then
     set -x
     copy_diff_files ../../conf/configure.nems.Theia.intel_gsm conf/configure.nems
     touch conf/externals.nems
     CHOSEN_MODULE="${CHOSEN_MODULE:-theia/ESMF_700_gsm}"
     copy_diff_mod "../../modulefiles/$CHOSEN_MODULE" conf/modules.nems
     copy_diff_files ESMFVersionDefine_ESMF_NUOPC.h ESMFVersionDefine.h
     set +x
     echo "NEMS/GSM build on Theia using Intel and ESMF v7.0.0"
elif [[ $1 = gsm_intel_wcoss ]]; then
     set -x
     copy_diff_files ../../conf/configure.nems.Wcoss.intel_gsm conf/configure.nems
     touch conf/externals.nems
     CHOSEN_MODULE="${CHOSEN_MODULE:-wcoss.phase1/ESMF_700_gsm}"
     copy_diff_mod "../../modulefiles/$CHOSEN_MODULE"      conf/modules.nems
     copy_diff_files ESMFVersionDefine_ESMF_NUOPC.h              ESMFVersionDefine.h
     set +x
     echo "NEMS/GSM build on Wcoss using Intel and ESMF v7.0.0"

elif [[ $1 = gsm_intel_wcoss_c ]]; then
     set -x
     copy_diff_files ../../conf/configure.nems.Wcoss_C.intel_gsm conf/configure.nems
     touch conf/externals.nems
     CHOSEN_MODULE="${CHOSEN_MODULE:-wcoss.cray/ESMF_700_gsm}"
     copy_diff_mod "../../modulefiles/$CHOSEN_MODULE"      conf/modules.nems
     copy_diff_files ESMFVersionDefine_ESMF_NUOPC.h              ESMFVersionDefine.h
     set +x
     echo "NEMS/GSM build on Wcoss using Intel and ESMF v7.0.0"
#
# Coupled
#
elif [[ $1 = coupled_intel_wcoss ]]; then
     copy_diff_files ../../conf/configure.nems.Wcoss.intel conf/configure.nems
     copy_diff_files ../../conf/externals.nems.Wcoss conf/externals.nems
     CHOSEN_MODULE="${CHOSEN_MODULE:-wcoss.phase1/ESMF_NUOPC}"
     copy_diff_mod "../../modulefiles/$CHOSEN_MODULE" conf/modules.nems
     copy_diff_files ESMFVersionDefine_ESMF_NUOPC.h ESMFVersionDefine.h
     echo "Coupled NEMS build on Wcoss using Intel and ESMF v7.0.0"
elif [[ $1 = coupled_intel_gaea ]]; then
     copy_diff_files ../../conf/configure.nems.Gaea.intel conf/configure.nems
     copy_diff_files ../../conf/externals.nems.Gaea conf/externals.nems
     CHOSEN_MODULE="${CHOSEN_MODULE:-gaea/ESMF_NUOPC}"
     copy_diff_mod "../../modulefiles/$CHOSEN_MODULE" conf/modules.nems
     copy_diff_files ESMFVersionDefine_ESMF_NUOPC.h ESMFVersionDefine.h
     echo "Coupled NEMS build on Gaea using Intel and ESMF v7.0.0"
elif [[ $1 = coupled_intel_theia ]]; then
     copy_diff_files ../../conf/configure.nems.Theia.intel conf/configure.nems
     copy_diff_files ../../conf/externals.nems.Theia conf/externals.nems
     CHOSEN_MODULE="${CHOSEN_MODULE:-theia/ESMF_NUOPC}"
     copy_diff_mod "../../modulefiles/$CHOSEN_MODULE" conf/modules.nems
     copy_diff_files ESMFVersionDefine_ESMF_NUOPC.h ESMFVersionDefine.h
     echo "Coupled NEMS build on Theia using Intel and ESMF v7.0.0"
elif [[ $1 = coupled_intel_yellowstone ]]; then
     copy_diff_files ../../conf/configure.nems.Yellowstone.intel conf/configure.nems
     copy_diff_files ../../conf/externals.nems.Yellowstone conf/externals.nems
     CHOSEN_MODULE="${CHOSEN_MODULE:-yellowstone/ESMF_NUOPC}"
     copy_diff_mod "../../modulefiles/$CHOSEN_MODULE" conf/modules.nems
     copy_diff_files ESMFVersionDefine_ESMF_NUOPC.h ESMFVersionDefine.h
     echo "Coupled NEMS build on Yellowstone using Intel and ESMF v7.0.0"
elif [[ $1 = coupled_linux_gnu ]]; then
     copy_diff_files ../../conf/configure.nems.Linux.gnu conf/configure.nems
     copy_diff_files ../../conf/externals.nems.Linux.gnu conf/externals.nems
     copy_diff_files ESMFVersionDefine_ESMF_NUOPC.h ESMFVersionDefine.h
     echo "Coupled NEMS build on Linux using GNU and ESMF v7.0.0"

#
# help message
#
else
     echo;echo "     Run ./configure with one argument:"
     echo;
     echo " 'configure nmmb_intel_wcoss'  : NEMS/NMMB build on Wcoss using Intel and ESMF v7.0.0"
     echo " 'configure nmmb_intel_theia'  : NEMS/NMMB build on Theia using Intel and ESMF v7.0.0"
     echo " 'configure gsm_intel_wcoss'   : NEMS/GSM build on Wcoss using Intel and ESMF v7.0.0"
     echo " 'configure gsm_intel_theia'   : NEMS/GSM build on Theia using Intel and ESMF v7.0.0"
     echo " 'configure gsm_intel_wcoss_c' : NEMS/GSM build on Crays using Intel and ESMF v7.0.0"
     echo;
     echo " 'configure coupled_intel_wcoss'       : Coupled NEMS build on Wcoss using Intel and ESMF v7.0.0"
     echo " 'configure coupled_intel_gaea'        : Coupled NEMS build on Gaea using Intel and ESMF v7.0.0"
     echo " 'configure coupled_intel_theia'       : Coupled NEMS build on Theia using Intel and ESMF v7.0.0"
     echo " 'configure coupled_intel_yellowstone' : Coupled NEMS build on Yellowstone using Intel and ESMF v7.0.0"
     echo " 'configure coupled_linux_gnu'         : Coupled NEMS build on Linux using GNU and ESMF v7.0.0"
     echo;
fi

